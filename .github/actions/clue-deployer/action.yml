---
# but first do the registry setup and builder setup, bevor using clue_deployer 
# Ensure registry and builder setup are completed before using clue_deployer
name: CLUE Deploy Action
description: Deploys the SUT via Helm in a Kubernetes cluster
inputs:
  clue-config-path:
    description: 'Path to the Helm chart directory'
    required: true
  sut-config-path:
    description: 'Path to the sut-config.yaml file; should have the same value as clue2-sose25/sut-configs/teastore.yml for example'
    required: true
  image-registry:
    description: 'Docker image name or tag to deploy (should match the value in sut-config.yaml)'
    required: true  
  variants-name:
    description: 'Name of the variant or experiment, e.g., "baseline", which targets the main branch and is also specified in the sut-config.'
    required: true
  results-path:
    description: 'Directory on the runner to store CLUE results'
    default: clue_results
runs:
  using: "composite"
  steps:
  - run: |
     # Start the CLUE Deployer container as a service
     docker run -d --name test_clue_deployer \
       -v ${{ inputs['clue-config-path']  }}:/app/clue-config.yaml \
       -v ${{ inputs['sut-config-path'] }}:/app/sut-config.yaml \
       -v ${{ inputs['results-path'] }}:/app/results \
       -e DEPLOY_AS_SERVICE=false -p 9001:8000 -e EXPERIMENT_NAME=${{ inputs.variants-name }} -e SUT=${{ inputs['sut-config-path'] }} -e DEPLOY_ONLY=false -e N_ITERATIONS=1\
       ghcr.io/clue2-sose25/clue2-deployer:dev
     sleep 60
     docker logs test_clue_deployer  || true
    shell: bash
  - name: Upload CLUE results
    uses: actions/upload-artifact@v3
    with:
      name: clue-results
      path: ${{ inputs['results-path'] }}